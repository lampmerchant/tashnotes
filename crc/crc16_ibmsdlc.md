# CRC-16/IBM-SDLC

[CRC-16/IBM-SDLC](https://reveng.sourceforge.io/crc-catalogue/16.htm#crc.cat.crc-16-ibm-sdlc) is used by, among other things, LocalTalk.


## Pseudocode

### Lookup Table

| Offset | +0     | +1     | +2     | +3     | +4     | +5     | +6     | +7     |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 0x00   | 0x0000 | 0x1189 | 0x2312 | 0x329B | 0x4624 | 0x57AD | 0x6536 | 0x74BF |
| 0x08   | 0x8C48 | 0x9DC1 | 0xAF5A | 0xBED3 | 0xCA6C | 0xDBE5 | 0xE97E | 0xF8F7 |
| 0x10   | 0x1081 | 0x0108 | 0x3393 | 0x221A | 0x56A5 | 0x472C | 0x75B7 | 0x643E |
| 0x18   | 0x9CC9 | 0x8D40 | 0xBFDB | 0xAE52 | 0xDAED | 0xCB64 | 0xF9FF | 0xE876 |
| 0x20   | 0x2102 | 0x308B | 0x0210 | 0x1399 | 0x6726 | 0x76AF | 0x4434 | 0x55BD |
| 0x28   | 0xAD4A | 0xBCC3 | 0x8E58 | 0x9FD1 | 0xEB6E | 0xFAE7 | 0xC87C | 0xD9F5 |
| 0x30   | 0x3183 | 0x200A | 0x1291 | 0x0318 | 0x77A7 | 0x662E | 0x54B5 | 0x453C |
| 0x38   | 0xBDCB | 0xAC42 | 0x9ED9 | 0x8F50 | 0xFBEF | 0xEA66 | 0xD8FD | 0xC974 |
| 0x40   | 0x4204 | 0x538D | 0x6116 | 0x709F | 0x0420 | 0x15A9 | 0x2732 | 0x36BB |
| 0x48   | 0xCE4C | 0xDFC5 | 0xED5E | 0xFCD7 | 0x8868 | 0x99E1 | 0xAB7A | 0xBAF3 |
| 0x50   | 0x5285 | 0x430C | 0x7197 | 0x601E | 0x14A1 | 0x0528 | 0x37B3 | 0x263A |
| 0x58   | 0xDECD | 0xCF44 | 0xFDDF | 0xEC56 | 0x98E9 | 0x8960 | 0xBBFB | 0xAA72 |
| 0x60   | 0x6306 | 0x728F | 0x4014 | 0x519D | 0x2522 | 0x34AB | 0x0630 | 0x17B9 |
| 0x68   | 0xEF4E | 0xFEC7 | 0xCC5C | 0xDDD5 | 0xA96A | 0xB8E3 | 0x8A78 | 0x9BF1 |
| 0x70   | 0x7387 | 0x620E | 0x5095 | 0x411C | 0x35A3 | 0x242A | 0x16B1 | 0x0738 |
| 0x78   | 0xFFCF | 0xEE46 | 0xDCDD | 0xCD54 | 0xB9EB | 0xA862 | 0x9AF9 | 0x8B70 |
| 0x80   | 0x8408 | 0x9581 | 0xA71A | 0xB693 | 0xC22C | 0xD3A5 | 0xE13E | 0xF0B7 |
| 0x88   | 0x0840 | 0x19C9 | 0x2B52 | 0x3ADB | 0x4E64 | 0x5FED | 0x6D76 | 0x7CFF |
| 0x90   | 0x9489 | 0x8500 | 0xB79B | 0xA612 | 0xD2AD | 0xC324 | 0xF1BF | 0xE036 |
| 0x98   | 0x18C1 | 0x0948 | 0x3BD3 | 0x2A5A | 0x5EE5 | 0x4F6C | 0x7DF7 | 0x6C7E |
| 0xA0   | 0xA50A | 0xB483 | 0x8618 | 0x9791 | 0xE32E | 0xF2A7 | 0xC03C | 0xD1B5 |
| 0xA8   | 0x2942 | 0x38CB | 0x0A50 | 0x1BD9 | 0x6F66 | 0x7EEF | 0x4C74 | 0x5DFD |
| 0xB0   | 0xB58B | 0xA402 | 0x9699 | 0x8710 | 0xF3AF | 0xE226 | 0xD0BD | 0xC134 |
| 0xB8   | 0x39C3 | 0x284A | 0x1AD1 | 0x0B58 | 0x7FE7 | 0x6E6E | 0x5CF5 | 0x4D7C |
| 0xC0   | 0xC60C | 0xD785 | 0xE51E | 0xF497 | 0x8028 | 0x91A1 | 0xA33A | 0xB2B3 |
| 0xC8   | 0x4A44 | 0x5BCD | 0x6956 | 0x78DF | 0x0C60 | 0x1DE9 | 0x2F72 | 0x3EFB |
| 0xD0   | 0xD68D | 0xC704 | 0xF59F | 0xE416 | 0x90A9 | 0x8120 | 0xB3BB | 0xA232 |
| 0xD8   | 0x5AC5 | 0x4B4C | 0x79D7 | 0x685E | 0x1CE1 | 0x0D68 | 0x3FF3 | 0x2E7A |
| 0xE0   | 0xE70E | 0xF687 | 0xC41C | 0xD595 | 0xA12A | 0xB0A3 | 0x8238 | 0x93B1 |
| 0xE8   | 0x6B46 | 0x7ACF | 0x4854 | 0x59DD | 0x2D62 | 0x3CEB | 0x0E70 | 0x1FF9 |
| 0xF0   | 0xF78F | 0xE606 | 0xD49D | 0xC514 | 0xB1AB | 0xA022 | 0x92B9 | 0x8330 |
| 0xF8   | 0x7BC7 | 0x6A4E | 0x58D5 | 0x495C | 0x3DE3 | 0x2C6A | 0x1EF1 | 0x0F78 |


### Initialization

Initialize register to `0xFFFF`.


### Update Algorithm

* `index = (register & 0xFF) ^ input_byte`
* `register = (register >> 8) ^ LUT[index]`


### Verification

If the correct CRC register value is fed into the update algorithm, LSB followed by MSB, the register will equal `0x0000`.


## PIC16 Implementation

### Lookup Table

```
	org	0x??00 ;must be aligned to a 256-word boundary

;This table is able to fit in 14-bit PIC16 words by reversing the bytes and
; truncating the two most significant bits, as bits 4 and 3 are equal to the
; truncated bits 15 and 14.
LutCrc16
	dw	0x0000,0x0911,0x1223,0x1B32,0x2446,0x2D57,0x3665,0x3F74
	dw	0x088C,0x019D,0x1AAF,0x13BE,0x2CCA,0x25DB,0x3EE9,0x37F8
	dw	0x0110,0x0801,0x1333,0x1A22,0x2556,0x2C47,0x3775,0x3E64
	dw	0x099C,0x008D,0x1BBF,0x12AE,0x2DDA,0x24CB,0x3FF9,0x36E8
	dw	0x0221,0x0B30,0x1002,0x1913,0x2667,0x2F76,0x3444,0x3D55
	dw	0x0AAD,0x03BC,0x188E,0x119F,0x2EEB,0x27FA,0x3CC8,0x35D9
	dw	0x0331,0x0A20,0x1112,0x1803,0x2777,0x2E66,0x3554,0x3C45
	dw	0x0BBD,0x02AC,0x199E,0x108F,0x2FFB,0x26EA,0x3DD8,0x34C9
	dw	0x0442,0x0D53,0x1661,0x1F70,0x2004,0x2915,0x3227,0x3B36
	dw	0x0CCE,0x05DF,0x1EED,0x17FC,0x2888,0x2199,0x3AAB,0x33BA
	dw	0x0552,0x0C43,0x1771,0x1E60,0x2114,0x2805,0x3337,0x3A26
	dw	0x0DDE,0x04CF,0x1FFD,0x16EC,0x2998,0x2089,0x3BBB,0x32AA
	dw	0x0663,0x0F72,0x1440,0x1D51,0x2225,0x2B34,0x3006,0x3917
	dw	0x0EEF,0x07FE,0x1CCC,0x15DD,0x2AA9,0x23B8,0x388A,0x319B
	dw	0x0773,0x0E62,0x1550,0x1C41,0x2335,0x2A24,0x3116,0x3807
	dw	0x0FFF,0x06EE,0x1DDC,0x14CD,0x2BB9,0x22A8,0x399A,0x308B
	dw	0x0884,0x0195,0x1AA7,0x13B6,0x2CC2,0x25D3,0x3EE1,0x37F0
	dw	0x0008,0x0919,0x122B,0x1B3A,0x244E,0x2D5F,0x366D,0x3F7C
	dw	0x0994,0x0085,0x1BB7,0x12A6,0x2DD2,0x24C3,0x3FF1,0x36E0
	dw	0x0118,0x0809,0x133B,0x1A2A,0x255E,0x2C4F,0x377D,0x3E6C
	dw	0x0AA5,0x03B4,0x1886,0x1197,0x2EE3,0x27F2,0x3CC0,0x35D1
	dw	0x0229,0x0B38,0x100A,0x191B,0x266F,0x2F7E,0x344C,0x3D5D
	dw	0x0BB5,0x02A4,0x1996,0x1087,0x2FF3,0x26E2,0x3DD0,0x34C1
	dw	0x0339,0x0A28,0x111A,0x180B,0x277F,0x2E6E,0x355C,0x3C4D
	dw	0x0CC6,0x05D7,0x1EE5,0x17F4,0x2880,0x2191,0x3AA3,0x33B2
	dw	0x044A,0x0D5B,0x1669,0x1F78,0x200C,0x291D,0x322F,0x3B3E
	dw	0x0DD6,0x04C7,0x1FF5,0x16E4,0x2990,0x2081,0x3BB3,0x32A2
	dw	0x055A,0x0C4B,0x1779,0x1E68,0x211C,0x280D,0x333F,0x3A2E
	dw	0x0EE7,0x07F6,0x1CC4,0x15D5,0x2AA1,0x23B0,0x3882,0x3193
	dw	0x066B,0x0F7A,0x1448,0x1D59,0x222D,0x2B3C,0x300E,0x391F
	dw	0x0FF7,0x06E6,0x1DD4,0x14C5,0x2BB1,0x22A0,0x3992,0x3083
	dw	0x077B,0x0E6A,0x1558,0x1C49,0x233D,0x2A2C,0x311E,0x380F
```


### Update Algorithm

```
;Update CRC_H:CRC_L with the byte in W (21 cycles)
UpdateCrc
	movlb	3		;Switch to where program memory registers are
	xorwf	CRC_H,W		;XOR the input byte (in W) with the high byte of
	movwf	PMADRL		; the register and look up this word in the
	movlw	high LutCrc16	; lookup table
	movwf	PMADRH		; "
	bcf	INTCON,GIE	; "
	bsf	PMCON1,RD	; "
	nop			; "
	nop			; "
	bsf	INTCON,GIE	; "
	movf	CRC_L,W		;XOR the low byte of the register with the high
	xorwf	PMDATH,W	; byte from the lookup table, reconstructing the
	btfsc	PMDATL,3	; missing top two bits from bits 3 and 2 of the
	xorlw	B'01000000'	; low byte of the lookup table, and make this
	btfsc	PMDATL,4	; the new high byte of the register
	xorlw	B'10000000'	; "
	movwf	CRC_H		; "
	movf	PMDATL,W	;Make the low byte from the lookup table the
	movwf	CRC_L		; new low byte of the register
	return			;Done
```
