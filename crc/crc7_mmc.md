# CRC-7/MMC

[CRC-7/MMC](https://reveng.sourceforge.io/crc-catalogue/1-15.htm#crc.cat.crc-7-mmc) is used by SD/MMC cards.


## Pseudocode

### Lookup Table

| Offset | +0   | +1   | +2   | +3   | +4   | +5   | +6   | +7   |
| ------ | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 0x00   | 0x00 | 0x09 | 0x12 | 0x1B | 0x24 | 0x2D | 0x36 | 0x3F |
| 0x08   | 0x48 | 0x41 | 0x5A | 0x53 | 0x6C | 0x65 | 0x7E | 0x77 |
| 0x10   | 0x19 | 0x10 | 0x0B | 0x02 | 0x3D | 0x34 | 0x2F | 0x26 |
| 0x18   | 0x51 | 0x58 | 0x43 | 0x4A | 0x75 | 0x7C | 0x67 | 0x6E |
| 0x20   | 0x32 | 0x3B | 0x20 | 0x29 | 0x16 | 0x1F | 0x04 | 0x0D |
| 0x28   | 0x7A | 0x73 | 0x68 | 0x61 | 0x5E | 0x57 | 0x4C | 0x45 |
| 0x30   | 0x2B | 0x22 | 0x39 | 0x30 | 0x0F | 0x06 | 0x1D | 0x14 |
| 0x38   | 0x63 | 0x6A | 0x71 | 0x78 | 0x47 | 0x4E | 0x55 | 0x5C |
| 0x40   | 0x64 | 0x6D | 0x76 | 0x7F | 0x40 | 0x49 | 0x52 | 0x5B |
| 0x48   | 0x2C | 0x25 | 0x3E | 0x37 | 0x08 | 0x01 | 0x1A | 0x13 |
| 0x50   | 0x7D | 0x74 | 0x6F | 0x66 | 0x59 | 0x50 | 0x4B | 0x42 |
| 0x58   | 0x35 | 0x3C | 0x27 | 0x2E | 0x11 | 0x18 | 0x03 | 0x0A |
| 0x60   | 0x56 | 0x5F | 0x44 | 0x4D | 0x72 | 0x7B | 0x60 | 0x69 |
| 0x68   | 0x1E | 0x17 | 0x0C | 0x05 | 0x3A | 0x33 | 0x28 | 0x21 |
| 0x70   | 0x4F | 0x46 | 0x5D | 0x54 | 0x6B | 0x62 | 0x79 | 0x70 |
| 0x78   | 0x07 | 0x0E | 0x15 | 0x1C | 0x23 | 0x2A | 0x31 | 0x38 |
| 0x80   | 0x41 | 0x48 | 0x53 | 0x5A | 0x65 | 0x6C | 0x77 | 0x7E |
| 0x88   | 0x09 | 0x00 | 0x1B | 0x12 | 0x2D | 0x24 | 0x3F | 0x36 |
| 0x90   | 0x58 | 0x51 | 0x4A | 0x43 | 0x7C | 0x75 | 0x6E | 0x67 |
| 0x98   | 0x10 | 0x19 | 0x02 | 0x0B | 0x34 | 0x3D | 0x26 | 0x2F |
| 0xA0   | 0x73 | 0x7A | 0x61 | 0x68 | 0x57 | 0x5E | 0x45 | 0x4C |
| 0xA8   | 0x3B | 0x32 | 0x29 | 0x20 | 0x1F | 0x16 | 0x0D | 0x04 |
| 0xB0   | 0x6A | 0x63 | 0x78 | 0x71 | 0x4E | 0x47 | 0x5C | 0x55 |
| 0xB8   | 0x22 | 0x2B | 0x30 | 0x39 | 0x06 | 0x0F | 0x14 | 0x1D |
| 0xC0   | 0x25 | 0x2C | 0x37 | 0x3E | 0x01 | 0x08 | 0x13 | 0x1A |
| 0xC8   | 0x6D | 0x64 | 0x7F | 0x76 | 0x49 | 0x40 | 0x5B | 0x52 |
| 0xD0   | 0x3C | 0x35 | 0x2E | 0x27 | 0x18 | 0x11 | 0x0A | 0x03 |
| 0xD8   | 0x74 | 0x7D | 0x66 | 0x6F | 0x50 | 0x59 | 0x42 | 0x4B |
| 0xE0   | 0x17 | 0x1E | 0x05 | 0x0C | 0x33 | 0x3A | 0x21 | 0x28 |
| 0xE8   | 0x5F | 0x56 | 0x4D | 0x44 | 0x7B | 0x72 | 0x69 | 0x60 |
| 0xF0   | 0x0E | 0x07 | 0x1C | 0x15 | 0x2A | 0x23 | 0x38 | 0x31 |
| 0xF8   | 0x46 | 0x4F | 0x54 | 0x5D | 0x62 | 0x6B | 0x70 | 0x79 |


### Initialization

Initialize register to `0x00`.


### Update Algorithm

* `index = (register << 1) ^ input_byte`
* `register = LUT[index]`


### Verification

If the correct CRC register value, shifted left by one bit, is fed into the update algorithm, the register will equal `0x00`.


## PIC16 Implementation

This implementation keeps the CRC register in the upper 7 bytes of `CRC`, with the LSb always equal to 0, as required by the SD/MMC protocol.


### Lookup Table

```
	org	0x??00 ;must be aligned to a 256-word boundary

LutCrc7
	dt	0x00,0x12,0x24,0x36,0x48,0x5A,0x6C,0x7E
	dt	0x90,0x82,0xB4,0xA6,0xD8,0xCA,0xFC,0xEE
	dt	0x32,0x20,0x16,0x04,0x7A,0x68,0x5E,0x4C
	dt	0xA2,0xB0,0x86,0x94,0xEA,0xF8,0xCE,0xDC
	dt	0x64,0x76,0x40,0x52,0x2C,0x3E,0x08,0x1A
	dt	0xF4,0xE6,0xD0,0xC2,0xBC,0xAE,0x98,0x8A
	dt	0x56,0x44,0x72,0x60,0x1E,0x0C,0x3A,0x28
	dt	0xC6,0xD4,0xE2,0xF0,0x8E,0x9C,0xAA,0xB8
	dt	0xC8,0xDA,0xEC,0xFE,0x80,0x92,0xA4,0xB6
	dt	0x58,0x4A,0x7C,0x6E,0x10,0x02,0x34,0x26
	dt	0xFA,0xE8,0xDE,0xCC,0xB2,0xA0,0x96,0x84
	dt	0x6A,0x78,0x4E,0x5C,0x22,0x30,0x06,0x14
	dt	0xAC,0xBE,0x88,0x9A,0xE4,0xF6,0xC0,0xD2
	dt	0x3C,0x2E,0x18,0x0A,0x74,0x66,0x50,0x42
	dt	0x9E,0x8C,0xBA,0xA8,0xD6,0xC4,0xF2,0xE0
	dt	0x0E,0x1C,0x2A,0x38,0x46,0x54,0x62,0x70
	dt	0x82,0x90,0xA6,0xB4,0xCA,0xD8,0xEE,0xFC
	dt	0x12,0x00,0x36,0x24,0x5A,0x48,0x7E,0x6C
	dt	0xB0,0xA2,0x94,0x86,0xF8,0xEA,0xDC,0xCE
	dt	0x20,0x32,0x04,0x16,0x68,0x7A,0x4C,0x5E
	dt	0xE6,0xF4,0xC2,0xD0,0xAE,0xBC,0x8A,0x98
	dt	0x76,0x64,0x52,0x40,0x3E,0x2C,0x1A,0x08
	dt	0xD4,0xC6,0xF0,0xE2,0x9C,0x8E,0xB8,0xAA
	dt	0x44,0x56,0x60,0x72,0x0C,0x1E,0x28,0x3A
	dt	0x4A,0x58,0x6E,0x7C,0x02,0x10,0x26,0x34
	dt	0xDA,0xC8,0xFE,0xEC,0x92,0x80,0xB6,0xA4
	dt	0x78,0x6A,0x5C,0x4E,0x30,0x22,0x14,0x06
	dt	0xE8,0xFA,0xCC,0xDE,0xA0,0xB2,0x84,0x96
	dt	0x2E,0x3C,0x0A,0x18,0x66,0x74,0x42,0x50
	dt	0xBE,0xAC,0x9A,0x88,0xF6,0xE4,0xD2,0xC0
	dt	0x1C,0x0E,0x38,0x2A,0x54,0x46,0x70,0x62
	dt	0x8C,0x9E,0xA8,0xBA,0xC4,0xD6,0xE0,0xF2
```

### Update Algorithm

```
;Update CRC 
UpdateCrc
	xorwf	CRC,W		;XOR CRC register with input byte
	movlp	high LutCrc7	;Look up result in lookup table
	callw			; "
	movwf	CRC		;Store it
	return			;Done
```
