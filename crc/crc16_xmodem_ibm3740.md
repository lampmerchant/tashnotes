# CRC-16/XMODEM and CRC-16/IBM-3740

[CRC-16/XMODEM](https://reveng.sourceforge.io/crc-catalogue/16.htm#crc.cat.crc-16-xmodem) is used by, among other things, SD/MMC cards.

[CRC-16/IBM-3740](https://reveng.sourceforge.io/crc-catalogue/16.htm#crc.cat.crc-16-ibm-3740) is used by, among other things, IBM PC MFM floppy disks.

Both algorithms are sometimes incorrectly referred to as [CRC-16/CCITT](https://reveng.sourceforge.io/crc-catalogue/16.htm#crc.cat.crc-16-kermit) because they use the CCITT polynomial, 0x1021.


## Pseudocode

### Lookup Table

| Offset | +0     | +1     | +2     | +3     | +4     | +5     | +6     | +7     |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 0x00   | 0x0000 | 0x1021 | 0x2042 | 0x3063 | 0x4084 | 0x50A5 | 0x60C6 | 0x70E7 |
| 0x08   | 0x8108 | 0x9129 | 0xA14A | 0xB16B | 0xC18C | 0xD1AD | 0xE1CE | 0xF1EF |
| 0x10   | 0x1231 | 0x0210 | 0x3273 | 0x2252 | 0x52B5 | 0x4294 | 0x72F7 | 0x62D6 |
| 0x18   | 0x9339 | 0x8318 | 0xB37B | 0xA35A | 0xD3BD | 0xC39C | 0xF3FF | 0xE3DE |
| 0x20   | 0x2462 | 0x3443 | 0x0420 | 0x1401 | 0x64E6 | 0x74C7 | 0x44A4 | 0x5485 |
| 0x28   | 0xA56A | 0xB54B | 0x8528 | 0x9509 | 0xE5EE | 0xF5CF | 0xC5AC | 0xD58D |
| 0x30   | 0x3653 | 0x2672 | 0x1611 | 0x0630 | 0x76D7 | 0x66F6 | 0x5695 | 0x46B4 |
| 0x38   | 0xB75B | 0xA77A | 0x9719 | 0x8738 | 0xF7DF | 0xE7FE | 0xD79D | 0xC7BC |
| 0x40   | 0x48C4 | 0x58E5 | 0x6886 | 0x78A7 | 0x0840 | 0x1861 | 0x2802 | 0x3823 |
| 0x48   | 0xC9CC | 0xD9ED | 0xE98E | 0xF9AF | 0x8948 | 0x9969 | 0xA90A | 0xB92B |
| 0x50   | 0x5AF5 | 0x4AD4 | 0x7AB7 | 0x6A96 | 0x1A71 | 0x0A50 | 0x3A33 | 0x2A12 |
| 0x58   | 0xDBFD | 0xCBDC | 0xFBBF | 0xEB9E | 0x9B79 | 0x8B58 | 0xBB3B | 0xAB1A |
| 0x60   | 0x6CA6 | 0x7C87 | 0x4CE4 | 0x5CC5 | 0x2C22 | 0x3C03 | 0x0C60 | 0x1C41 |
| 0x68   | 0xEDAE | 0xFD8F | 0xCDEC | 0xDDCD | 0xAD2A | 0xBD0B | 0x8D68 | 0x9D49 |
| 0x70   | 0x7E97 | 0x6EB6 | 0x5ED5 | 0x4EF4 | 0x3E13 | 0x2E32 | 0x1E51 | 0x0E70 |
| 0x78   | 0xFF9F | 0xEFBE | 0xDFDD | 0xCFFC | 0xBF1B | 0xAF3A | 0x9F59 | 0x8F78 |
| 0x80   | 0x9188 | 0x81A9 | 0xB1CA | 0xA1EB | 0xD10C | 0xC12D | 0xF14E | 0xE16F |
| 0x88   | 0x1080 | 0x00A1 | 0x30C2 | 0x20E3 | 0x5004 | 0x4025 | 0x7046 | 0x6067 |
| 0x90   | 0x83B9 | 0x9398 | 0xA3FB | 0xB3DA | 0xC33D | 0xD31C | 0xE37F | 0xF35E |
| 0x98   | 0x02B1 | 0x1290 | 0x22F3 | 0x32D2 | 0x4235 | 0x5214 | 0x6277 | 0x7256 |
| 0xA0   | 0xB5EA | 0xA5CB | 0x95A8 | 0x8589 | 0xF56E | 0xE54F | 0xD52C | 0xC50D |
| 0xA8   | 0x34E2 | 0x24C3 | 0x14A0 | 0x0481 | 0x7466 | 0x6447 | 0x5424 | 0x4405 |
| 0xB0   | 0xA7DB | 0xB7FA | 0x8799 | 0x97B8 | 0xE75F | 0xF77E | 0xC71D | 0xD73C |
| 0xB8   | 0x26D3 | 0x36F2 | 0x0691 | 0x16B0 | 0x6657 | 0x7676 | 0x4615 | 0x5634 |
| 0xC0   | 0xD94C | 0xC96D | 0xF90E | 0xE92F | 0x99C8 | 0x89E9 | 0xB98A | 0xA9AB |
| 0xC8   | 0x5844 | 0x4865 | 0x7806 | 0x6827 | 0x18C0 | 0x08E1 | 0x3882 | 0x28A3 |
| 0xD0   | 0xCB7D | 0xDB5C | 0xEB3F | 0xFB1E | 0x8BF9 | 0x9BD8 | 0xABBB | 0xBB9A |
| 0xD8   | 0x4A75 | 0x5A54 | 0x6A37 | 0x7A16 | 0x0AF1 | 0x1AD0 | 0x2AB3 | 0x3A92 |
| 0xE0   | 0xFD2E | 0xED0F | 0xDD6C | 0xCD4D | 0xBDAA | 0xAD8B | 0x9DE8 | 0x8DC9 |
| 0xE8   | 0x7C26 | 0x6C07 | 0x5C64 | 0x4C45 | 0x3CA2 | 0x2C83 | 0x1CE0 | 0x0CC1 |
| 0xF0   | 0xEF1F | 0xFF3E | 0xCF5D | 0xDF7C | 0xAF9B | 0xBFBA | 0x8FD9 | 0x9FF8 |
| 0xF8   | 0x6E17 | 0x7E36 | 0x4E55 | 0x5E74 | 0x2E93 | 0x3EB2 | 0x0ED1 | 0x1EF0 |


### Initialization

* For CRC-16/XMODEM, initialize register to `0x0000`.
* For CRC-16/IBM-3740, initialize register to `0xFFFF`.


### Update Algorithm

* `index = (register >> 8) ^ input_byte`
* `register = ((register << 8) & 0xFF00) ^ LUT[index]`


### Verification

If the correct CRC register value is fed into the update algorithm, MSB followed by LSB, the register will equal `0x0000`.


## PIC16 Implementation 1

### Lookup Table

```
	org	0x??00 ;must be aligned to a 256-word boundary

;This table is able to fit in 14-bit PIC16 words by truncating the two most
; significant bits, as bits 3 and 2 are equal to the truncated bits 15 and 14.
LutCrc16
	dw	0x0000,0x1021,0x2042,0x3063,0x0084,0x10A5,0x20C6,0x30E7
	dw	0x0108,0x1129,0x214A,0x316B,0x018C,0x11AD,0x21CE,0x31EF
	dw	0x1231,0x0210,0x3273,0x2252,0x12B5,0x0294,0x32F7,0x22D6
	dw	0x1339,0x0318,0x337B,0x235A,0x13BD,0x039C,0x33FF,0x23DE
	dw	0x2462,0x3443,0x0420,0x1401,0x24E6,0x34C7,0x04A4,0x1485
	dw	0x256A,0x354B,0x0528,0x1509,0x25EE,0x35CF,0x05AC,0x158D
	dw	0x3653,0x2672,0x1611,0x0630,0x36D7,0x26F6,0x1695,0x06B4
	dw	0x375B,0x277A,0x1719,0x0738,0x37DF,0x27FE,0x179D,0x07BC
	dw	0x08C4,0x18E5,0x2886,0x38A7,0x0840,0x1861,0x2802,0x3823
	dw	0x09CC,0x19ED,0x298E,0x39AF,0x0948,0x1969,0x290A,0x392B
	dw	0x1AF5,0x0AD4,0x3AB7,0x2A96,0x1A71,0x0A50,0x3A33,0x2A12
	dw	0x1BFD,0x0BDC,0x3BBF,0x2B9E,0x1B79,0x0B58,0x3B3B,0x2B1A
	dw	0x2CA6,0x3C87,0x0CE4,0x1CC5,0x2C22,0x3C03,0x0C60,0x1C41
	dw	0x2DAE,0x3D8F,0x0DEC,0x1DCD,0x2D2A,0x3D0B,0x0D68,0x1D49
	dw	0x3E97,0x2EB6,0x1ED5,0x0EF4,0x3E13,0x2E32,0x1E51,0x0E70
	dw	0x3F9F,0x2FBE,0x1FDD,0x0FFC,0x3F1B,0x2F3A,0x1F59,0x0F78
	dw	0x1188,0x01A9,0x31CA,0x21EB,0x110C,0x012D,0x314E,0x216F
	dw	0x1080,0x00A1,0x30C2,0x20E3,0x1004,0x0025,0x3046,0x2067
	dw	0x03B9,0x1398,0x23FB,0x33DA,0x033D,0x131C,0x237F,0x335E
	dw	0x02B1,0x1290,0x22F3,0x32D2,0x0235,0x1214,0x2277,0x3256
	dw	0x35EA,0x25CB,0x15A8,0x0589,0x356E,0x254F,0x152C,0x050D
	dw	0x34E2,0x24C3,0x14A0,0x0481,0x3466,0x2447,0x1424,0x0405
	dw	0x27DB,0x37FA,0x0799,0x17B8,0x275F,0x377E,0x071D,0x173C
	dw	0x26D3,0x36F2,0x0691,0x16B0,0x2657,0x3676,0x0615,0x1634
	dw	0x194C,0x096D,0x390E,0x292F,0x19C8,0x09E9,0x398A,0x29AB
	dw	0x1844,0x0865,0x3806,0x2827,0x18C0,0x08E1,0x3882,0x28A3
	dw	0x0B7D,0x1B5C,0x2B3F,0x3B1E,0x0BF9,0x1BD8,0x2BBB,0x3B9A
	dw	0x0A75,0x1A54,0x2A37,0x3A16,0x0AF1,0x1AD0,0x2AB3,0x3A92
	dw	0x3D2E,0x2D0F,0x1D6C,0x0D4D,0x3DAA,0x2D8B,0x1DE8,0x0DC9
	dw	0x3C26,0x2C07,0x1C64,0x0C45,0x3CA2,0x2C83,0x1CE0,0x0CC1
	dw	0x2F1F,0x3F3E,0x0F5D,0x1F7C,0x2F9B,0x3FBA,0x0FD9,0x1FF8
	dw	0x2E17,0x3E36,0x0E55,0x1E74,0x2E93,0x3EB2,0x0ED1,0x1EF0
```


### Update Algorithm

For some PIC16 microcontrollers, the registers beginning with `PM` should be changed to `EE`.

```
;Update CRC_H:CRC_L with the byte in W (21 cycles)
UpdateCrc
	movlb	3		;Switch to where program memory registers are
	xorwf	CRC_H,W		;XOR the input byte (in W) with the high byte of
	movwf	PMADRL		; the register and look up this word in the
	movlw	high LutCrc16	; lookup table
	movwf	PMADRH		; "
	bcf	INTCON,GIE	; "
	bsf	PMCON1,RD	; "
	nop			; "
	nop			; "
	bsf	INTCON,GIE	; "
	movf	CRC_L,W		;XOR the low byte of the register with the high
	xorwf	PMDATH,W	; byte from the lookup table, reconstructing the
	btfsc	PMDATL,2	; missing top two bits from bits 3 and 2 of the
	xorlw	B'01000000'	; low byte of the lookup table, and make this
	btfsc	PMDATL,3	; the new high byte of the register
	xorlw	B'10000000'	; "
	movwf	CRC_H		; "
	movf	PMDATL,W	;Make the low byte from the lookup table the
	movwf	CRC_L		; new low byte of the register
	return			;Done
```


## PIC16 Implementation 2

This implementation is very slightly faster, at the cost of more program memory.

### Lookup Tables

```
	org	0x??00 ;must be aligned to a 256-word boundary

LutCrc16H
	dt	0x00,0x10,0x20,0x30,0x40,0x50,0x60,0x70
	dt	0x81,0x91,0xA1,0xB1,0xC1,0xD1,0xE1,0xF1
	dt	0x12,0x02,0x32,0x22,0x52,0x42,0x72,0x62
	dt	0x93,0x83,0xB3,0xA3,0xD3,0xC3,0xF3,0xE3
	dt	0x24,0x34,0x04,0x14,0x64,0x74,0x44,0x54
	dt	0xA5,0xB5,0x85,0x95,0xE5,0xF5,0xC5,0xD5
	dt	0x36,0x26,0x16,0x06,0x76,0x66,0x56,0x46
	dt	0xB7,0xA7,0x97,0x87,0xF7,0xE7,0xD7,0xC7
	dt	0x48,0x58,0x68,0x78,0x08,0x18,0x28,0x38
	dt	0xC9,0xD9,0xE9,0xF9,0x89,0x99,0xA9,0xB9
	dt	0x5A,0x4A,0x7A,0x6A,0x1A,0x0A,0x3A,0x2A
	dt	0xDB,0xCB,0xFB,0xEB,0x9B,0x8B,0xBB,0xAB
	dt	0x6C,0x7C,0x4C,0x5C,0x2C,0x3C,0x0C,0x1C
	dt	0xED,0xFD,0xCD,0xDD,0xAD,0xBD,0x8D,0x9D
	dt	0x7E,0x6E,0x5E,0x4E,0x3E,0x2E,0x1E,0x0E
	dt	0xFF,0xEF,0xDF,0xCF,0xBF,0xAF,0x9F,0x8F
	dt	0x91,0x81,0xB1,0xA1,0xD1,0xC1,0xF1,0xE1
	dt	0x10,0x00,0x30,0x20,0x50,0x40,0x70,0x60
	dt	0x83,0x93,0xA3,0xB3,0xC3,0xD3,0xE3,0xF3
	dt	0x02,0x12,0x22,0x32,0x42,0x52,0x62,0x72
	dt	0xB5,0xA5,0x95,0x85,0xF5,0xE5,0xD5,0xC5
	dt	0x34,0x24,0x14,0x04,0x74,0x64,0x54,0x44
	dt	0xA7,0xB7,0x87,0x97,0xE7,0xF7,0xC7,0xD7
	dt	0x26,0x36,0x06,0x16,0x66,0x76,0x46,0x56
	dt	0xD9,0xC9,0xF9,0xE9,0x99,0x89,0xB9,0xA9
	dt	0x58,0x48,0x78,0x68,0x18,0x08,0x38,0x28
	dt	0xCB,0xDB,0xEB,0xFB,0x8B,0x9B,0xAB,0xBB
	dt	0x4A,0x5A,0x6A,0x7A,0x0A,0x1A,0x2A,0x3A
	dt	0xFD,0xED,0xDD,0xCD,0xBD,0xAD,0x9D,0x8D
	dt	0x7C,0x6C,0x5C,0x4C,0x3C,0x2C,0x1C,0x0C
	dt	0xEF,0xFF,0xCF,0xDF,0xAF,0xBF,0x8F,0x9F
	dt	0x6E,0x7E,0x4E,0x5E,0x2E,0x3E,0x0E,0x1E

LutCrc16L
	dt	0x00,0x21,0x42,0x63,0x84,0xA5,0xC6,0xE7
	dt	0x08,0x29,0x4A,0x6B,0x8C,0xAD,0xCE,0xEF
	dt	0x31,0x10,0x73,0x52,0xB5,0x94,0xF7,0xD6
	dt	0x39,0x18,0x7B,0x5A,0xBD,0x9C,0xFF,0xDE
	dt	0x62,0x43,0x20,0x01,0xE6,0xC7,0xA4,0x85
	dt	0x6A,0x4B,0x28,0x09,0xEE,0xCF,0xAC,0x8D
	dt	0x53,0x72,0x11,0x30,0xD7,0xF6,0x95,0xB4
	dt	0x5B,0x7A,0x19,0x38,0xDF,0xFE,0x9D,0xBC
	dt	0xC4,0xE5,0x86,0xA7,0x40,0x61,0x02,0x23
	dt	0xCC,0xED,0x8E,0xAF,0x48,0x69,0x0A,0x2B
	dt	0xF5,0xD4,0xB7,0x96,0x71,0x50,0x33,0x12
	dt	0xFD,0xDC,0xBF,0x9E,0x79,0x58,0x3B,0x1A
	dt	0xA6,0x87,0xE4,0xC5,0x22,0x03,0x60,0x41
	dt	0xAE,0x8F,0xEC,0xCD,0x2A,0x0B,0x68,0x49
	dt	0x97,0xB6,0xD5,0xF4,0x13,0x32,0x51,0x70
	dt	0x9F,0xBE,0xDD,0xFC,0x1B,0x3A,0x59,0x78
	dt	0x88,0xA9,0xCA,0xEB,0x0C,0x2D,0x4E,0x6F
	dt	0x80,0xA1,0xC2,0xE3,0x04,0x25,0x46,0x67
	dt	0xB9,0x98,0xFB,0xDA,0x3D,0x1C,0x7F,0x5E
	dt	0xB1,0x90,0xF3,0xD2,0x35,0x14,0x77,0x56
	dt	0xEA,0xCB,0xA8,0x89,0x6E,0x4F,0x2C,0x0D
	dt	0xE2,0xC3,0xA0,0x81,0x66,0x47,0x24,0x05
	dt	0xDB,0xFA,0x99,0xB8,0x5F,0x7E,0x1D,0x3C
	dt	0xD3,0xF2,0x91,0xB0,0x57,0x76,0x15,0x34
	dt	0x4C,0x6D,0x0E,0x2F,0xC8,0xE9,0x8A,0xAB
	dt	0x44,0x65,0x06,0x27,0xC0,0xE1,0x82,0xA3
	dt	0x7D,0x5C,0x3F,0x1E,0xF9,0xD8,0xBB,0x9A
	dt	0x75,0x54,0x37,0x16,0xF1,0xD0,0xB3,0x92
	dt	0x2E,0x0F,0x6C,0x4D,0xAA,0x8B,0xE8,0xC9
	dt	0x26,0x07,0x64,0x45,0xA2,0x83,0xE0,0xC1
	dt	0x1F,0x3E,0x5D,0x7C,0x9B,0xBA,0xD9,0xF8
	dt	0x17,0x36,0x55,0x74,0x93,0xB2,0xD1,0xF0
```


### Update Algorithm

```
;Update CRC_H:CRC_L with the byte in W (19 cycles)
UpdateCrc
	xorwf	CRC_H,W		;XOR input byte (in W) with the high byte of the
	movwf	CRC_H		; register and store this index for later use
	movlp	high LutCrc16H	;Look up the high byte in the lookup table
	callw			; "
	xorwf	CRC_L,W		;XOR the low byte of the register with the high
	xorwf	CRC_H,F		; byte from the lookup table and swap this value
	xorwf	CRC_H,W		; to be the new high byte of the register,
	xorwf	CRC_H,F		; leaving the lookup table index in W
	movlp	high LutCrc16L	;Look up the low byte in the lookup table
	callw			; "
	movwf	CRC_L		;Store this as the new low byte of the register
	return			;Done
```
